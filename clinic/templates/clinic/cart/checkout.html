{% extends 'clinic/base.html' %}
{% block content %}

<style>
.checkout-container {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    background: #1d1b1b;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid white;
}

h2 {
    text-align: center;
    margin-bottom: 25px;
    color: #333;
}

/* Order Summary */
.order-summary {
    margin-bottom: 30px;
}

.cart-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border: 1px solid #eee;
    border-radius: 8px;
    margin-bottom: 12px;
    background: #fafafa;
}

.cart-img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 15px;
}

.no-img {
    width: 60px;
    height: 60px;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    margin-right: 15px;
    font-size: 0.8rem;
}

.item-details {
    flex: 1;
}

.grand-total {
    text-align: right;
    font-size: 1.3rem;
    font-weight: bold;
    color: #28a745;
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px dashed #ddd;
}

/* Customer Info Form */
.customer-info-section {
    margin-bottom: 30px;
}

.customer-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-row {
    display: flex;
    flex-direction: column;
}

.form-row label {
    margin-bottom: 6px;
    font-weight: 600;
    color: #333;
}

.form-row input,
.form-row textarea {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
    outline: none;
}

.form-row textarea {
    min-height: 80px;
    resize: vertical;
}

.error {
    color: #dc3545;
    font-size: 0.9rem;
    margin-top: 4px;
}

.save-btn {
    background: #007bff;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
    align-self: flex-start;
}

.save-btn:hover {
    background: #0056b3;
}

/* Payment Section */
.payment-section {
    background: #1d1b1b;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    text-align: center;
}

.total-amount {
    font-size: 1.2rem;
    margin-bottom: 15px;
    color: #333;
}

.pay-btn {
    background: #28a745;
    color: white;
    padding: 12px 30px;
    border: none;
    border-radius: 6px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background 0.2s;
}

.pay-btn:hover {
    background: #218838;
}

.info-message {
    background: #fff3cd;
    padding: 15px;
    border-radius: 6px;
    color: #856404;
    text-align: center;
    margin: 20px 0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .checkout-container {
        margin: 10px;
        padding: 15px;
    }

    .cart-item {
        flex-direction: column;
        text-align: center;
    }

    .cart-img, .no-img {
        margin-right: 0;
        margin-bottom: 10px;
    }

    .grand-total {
        text-align: center;
    }

    .customer-form {
        gap: 12px;
    }

    .form-row input,
    .form-row textarea {
        padding: 12px;
        font-size: 1rem;
    }

    .save-btn, .pay-btn {
        width: 100%;
        padding: 14px;
        font-size: 1.1rem;
    }
}

/* Dark Mode */
@media (prefers-color-scheme: dark) {
    .checkout-container {
        background: #1e1e1e;
        color: #e0e0e0;
        box-shadow: 0 2px 10px rgba(255,255,255,0.05);
    }

    .cart-item {
        background: #2d2d2d;
        border-color: #444;
    }

    .no-img {
        background: #3a3a3a;
        color: #aaa;
    }

    .grand-total {
        color: #69f0ae;
    }

    .form-row label {
        color: #e0e0e0;
    }

    .form-row input,
    .form-row textarea {
        background: #2d2d2d;
        border-color: #444;
        color: #e0e0e0;
    }

    .save-btn {
        background: #64b5f6;
        color: #121212;
    }

    .save-btn:hover {
        background: #4da1db;
    }

    .payment-section {
        background: #2d2d2d;
        border-color: #444;
    }

    .pay-btn {
        background: #69f0ae;
        color: #121212;
    }

    .pay-btn:hover {
        background: #4dff91;
    }

    .info-message {
        background: #3a3a3a;
        color: #e0e0e0;
    }
}
</style>

<div class="checkout-container">
    <h2>Checkout</h2>

    <!-- Cart Summary -->
    <section class="order-summary">
        <h3>Order Summary</h3>
        {% for item in cart %}
            <div class="cart-item">
                {% if item.drug.image %}
                    <img src="{{ item.drug.image.url }}" alt="{{ item.drug.name }}" class="cart-img">
                {% else %}
                    <div class="no-img">No Image</div>
                {% endif %}
                <div class="item-details">
                    <strong>{{ item.drug.name }}</strong>
                    <p>₦{{ item.price|floatformat:2 }} × {{ item.quantity }}</p>
                    <p><strong>Total: ₦{{ item.total_price|floatformat:2 }}</strong></p>
                </div>
            </div>
        {% empty %}
            <p>No items in cart.</p>
        {% endfor %}
        <div class="grand-total">
            <strong>Grand Total: ₦{{ total|floatformat:2 }}</strong>
        </div>
    </section>

    <!-- Customer Info Form (Auto-Save) -->
    <section class="customer-info-section">
        <h3>Delivery & Contact Info</h3>
        <form id="customer-form" class="customer-form">
            {% csrf_token %}
            <div class="form-row">
                <label for="{{ form.name.id_for_label }}">Full Name *</label>
                {{ form.name }}
                <div class="error" id="error-name"></div>
            </div>
            <div class="form-row">
                <label for="{{ form.email.id_for_label }}">Email *</label>
                {{ form.email }}
                <div class="error" id="error-email"></div>
            </div>
            <div class="form-row">
                <label for="{{ form.phone.id_for_label }}">Phone Number *</label>
                {{ form.phone }}
                <div class="error" id="error-phone"></div>
            </div>
            <div class="form-row">
                <label for="{{ form.address.id_for_label }}">Delivery Address *</label>
                {{ form.address }}
                <div class="error" id="error-address"></div>
            </div>
            <!-- ✅ "Save Info" button REMOVED -->
        </form>
    </section>

    <!-- Paystack Button -->
    <section id="payment-section" class="payment-section" style="display: none;">
        <h3>Proceed to Payment</h3>
        <p class="total-amount">Total Amount: <strong>₦{{ total|floatformat:2 }}</strong></p>
        <button id="paystack-btn" class="btn pay-btn">Proceed to Payment</button>
    </section>

    <div id="info-message" class="info-message" style="display: block;">
        <p>Please fill in all delivery information to proceed.</p>
    </div>
</div>

<!-- Load Paystack SDK -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<!-- Auto-save & Paystack -->
{{ request.session.customer_info|json_script:"customer-info" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('customer-form');
    const fields = ['name', 'email', 'phone', 'address'];
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Show/hide payment section
    function updatePaymentSection() {
        const customerData = JSON.parse(document.getElementById('customer-info').textContent || '{}');
        const allFilled = fields.every(field => customerData[field] && customerData[field].trim() !== '');
        
        if (allFilled) {
            document.getElementById('payment-section').style.display = 'block';
            document.getElementById('info-message').style.display = 'none';
        } else {
            document.getElementById('payment-section').style.display = 'none';
            document.getElementById('info-message').style.display = 'block';
        }
    }

    // Auto-save on input change (with debounce)
    let saveTimeout;
    function autoSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            const formData = new FormData(form);
            fetch("{% url 'save_customer_info' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update session data in DOM
                    const script = document.getElementById('customer-info');
                    script.textContent = JSON.stringify(Object.fromEntries(formData));
                    updatePaymentSection();
                } else {
                    // Show field errors
                    fields.forEach(field => {
                        const errorDiv = document.getElementById(`error-${field}`);
                        errorDiv.textContent = data.errors?.[field]?.[0] || '';
                    });
                }
            })
            .catch(error => console.error('Auto-save error:', error));
        }, 800); // Wait 0.8s after user stops typing
    }

    // Attach event listeners
    fields.forEach(field => {
        const input = form.querySelector(`[name="${field}"]`);
        if (input) {
            input.addEventListener('input', autoSave);
        }
    });

    // Initialize UI
    updatePaymentSection();

    // Paystack button
    document.getElementById('paystack-btn')?.addEventListener('click', function() {
        try {
            const customerData = JSON.parse(document.getElementById('customer-info').textContent);
            PaystackPop.setup({
                key: '{{ paystack_public_key }}',
                email: customerData.email,
                amount: {{ amount_kobo }},
                currency: 'NGN',
                ref: 'REF_' + Math.floor((Math.random() * 1000000000) + 1),
                callback: function(response) {
                    window.location.href = "{% url 'verify_payment' %}?reference=" + response.reference;
                },
                onClose: function() {
                    alert('Payment was cancelled.');
                }
            }).openIframe();
        } catch (error) {
            alert("Please fill in all fields correctly.");
        }
    });
});
</script>




{% endblock %}